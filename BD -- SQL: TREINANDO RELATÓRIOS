-- Funcionario,cpf, cargaHoraria, chavepix, auxCreche, salario, telefone
use pousadaalambique;

select func.nome "Funcionário", func.cpf "CPF",Crg.nome "Cargo",concat(func.cargaHoraria,'h') "CargoHorária", func.chavePix "Chave pix",
concat("R$", format( coalesce(vac.auxCreche, 0), 2, 'de_DE')) "Auxílio Creche", -- 180 por filho menor que 7 menos / criado a nova tabela agora renomear ela e dale o raio /
-- se usar coalesce os campos que forem null irão aparecer zero ao inves de null no relatorio
concat( "R$", format(func.salario,1, 'de_DE')) "Salário",group_concat(tel.numero separator ', ') "Telefone"
		from funcionario func
        inner join  trabalhar trb on trb.Funcionario_CPF = func.CPF
        inner join cargo crg on crg.CBO = trb.Cargo_CBO
        inner join telefone tel on tel.Funcionario_CPF = func.cpf
        left join vauxcreche vac on vac.Funcionario_CPF = func.CPF -- nem todo funcionario vai ter o auxilo creche por isso o left
			where trb.dataFim is null and
            func.salario >= (select avg(salario) from funcionario)
            group by func.cpf, crg.CBO
            order by func.nome;
            

            
            
create view vAuxCreche as                               --  criei uma nova tabela com nome vAuxCreche com esse select  usando creat view
select Funcionario_CPF, count(cpf) * 180 "auxCreche"
	from dependente
		where timestampdiff(year, dataNasc, now()) < 7   -- somente dependetes com menos de 7 anos irão receber auxilio d 180 , tirei os que tem menos de 7 ans com timessatampdiff  pra saber quantos filhos com menos de 7 anos cda
														-- cada funcionario tem e depois multipliquei por 180 para saber quanto cada um ira ganhar			
			group by Funcionario_CPF;
            
            
create view  vRelatorioRH as      -- POSSO NOMEAR UM RELATORIO INTEIRO COMO POR EXEMPLO vRelatorioRH
select func.nome "Funcionário", func.cpf "CPF",Crg.nome "Cargo",concat(func.cargaHoraria,'h') "CargoHorária", func.chavePix "Chave pix",
concat("R$", format( coalesce(vac.auxCreche, 0), 2, 'de_DE')) "Auxílio Creche", -- 180 por filho menor que 7 menos / criado a nova tabela agora renomear ela e dale o raio /
-- se usar coalesce os campos que forem null irão aparecer zero ao inves de null no relatorio
concat( "R$", format(func.salario,1, 'de_DE')) "Salário",group_concat(tel.numero separator ', ') "Telefone"
		from funcionario func
        inner join  trabalhar trb on trb.Funcionario_CPF = func.CPF
        inner join cargo crg on crg.CBO = trb.Cargo_CBO
        inner join telefone tel on tel.Funcionario_CPF = func.cpf
        left join vauxcreche vac on vac.Funcionario_CPF = func.CPF -- nem todo funcionario vai ter o auxilo creche por isso o left
		where trb.dataFim is null and
         func.salario >= (select avg(salario) from funcionario) 
		group by func.cpf, crg.CBO
		order by func.nome;
            
select * from vRelatorioRH  -- e depois com o relatorio nomeado eu posso selecionar ele inteiro sem precisar repetir todos procedimentos
    where `Salário` >= avg(`Salário`);
    
select avg(salario) from funcionario; -- avg serve para pegar a média no caso do salario   

select dep.nome "Departamento", -- relatorio mostrando quando se gasta em cada departamento
	concat("R$", format(sum(func.salario), 2, 'de_DE')) "Custo Salarial", -- sum serve para somar e count serve para contar
    count(func.cpf) "Quantidade de Funcionário",  -- count para contar quantos funcionarios ha no departamento
    concat("R$ ",format(avg(func.salario), 2, 'de_DE')) "Media Salarial" -- avg para conseguir a media salarial ja concatenada e formatada
    from  departamento dep
    left join trabalhar trb on trb.Departamento_idDepartamento = dep.IdDepartamento
    inner join funcionario func on func.CPF = trb.Funcionario_CPF
		group by dep.IdDepartamento
        order by sum(func.salario) desc;
